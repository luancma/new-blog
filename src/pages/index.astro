---
import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import Fallback from "../assets/img/fallback.jpeg";
const allBlogPosts = await getCollection("blog");
import { DateTime } from "luxon";
import "./index.css";

const orderByDate = (a, b) => {
  const dateA = DateTime.fromFormat(a.data.createdAt, "dd/MM/yyyy").toJSDate();
  const dateB = DateTime.fromFormat(b.data.createdAt, "dd/MM/yyyy").toJSDate();
  return dateA - dateB;
};

const orderedPosts = allBlogPosts.sort(orderByDate);
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="stylesheet" href="/styles/global.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Domine:wght@400..700&display=swap"
      rel="stylesheet"
    />
    <meta name="robots" content="index, follow" />
    <meta name="author" content="UP - Lisboa, membro anonimo" />
    <meta
      name="keywords"
      content="blog, marxism, leninism, Portugal, critical texts, marxismo, trabalho, trabalhadores, proletário, proletariados"
    />
    <link rel="sitemap" href="/sitemap-index.xml" />
    <meta
      name="description"
      content="Espaço dedicado para o compartilhamento de textos críticos e pensamentos marxistas-leninistas, voltado para a realidade Portuguesa."
    />
    <title>Voz do Trabalhador</title>
  </head>
  <body>
    <div class="header">
      <h1>Voz do trabalhador</h1>
      <div class="divider"></div>
      <p>
        Espaço dedicado para o compartilhamento de textos críticos e pensamentos
        marxistas-leninistas, voltado para a realidade Portuguesa.
      </p>
    </div>

    <div class="posts-container">
      <h3>Postagens:</h3>
      <div class="posts-grid">
        {
          orderedPosts.map((post) => (
            <div
              class="post-item"
              id="post-item"
              data-slug={JSON.stringify(post.id)}
            >
              <Image
                class={"post-image"}
                src={Fallback}
                alt="cover image for posts"
              />
              <h3>{post?.rendered?.metadata?.frontmatter.title}</h3>
              <p class="post-tag">
                {post?.rendered?.metadata?.frontmatter.primaryTag}
              </p>
            </div>
          ))
        }
      </div>
    </div>
  </body>
</html>

<script lang="javascript">
  const posts = document.querySelectorAll("#post-item");

  posts.forEach((post) => {
    post.addEventListener("click", () => {
      const slug = JSON.parse(post.dataset.slug);
      const currentLocation = window.location.origin;
      const postUrl = `${currentLocation}/blog/${slug}.html`;
      return (window.location.href = postUrl);
    });
  });
</script>
