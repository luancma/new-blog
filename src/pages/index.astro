---
import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import Fallback from "../assets/img/fallback.jpeg";
import "/public/styles/blogIndex.css";
const allBlogPosts = await getCollection("blog");
import { DateTime } from "luxon";
import Layout from "../layouts/Layout.astro";

const orderByDate = (a, b) => {
  const dateA = DateTime.fromFormat(a.data.createdAt, "dd/MM/yyyy").toJSDate();
  const dateB = DateTime.fromFormat(b.data.createdAt, "dd/MM/yyyy").toJSDate();
  return dateA - dateB;
};

const orderedPosts = allBlogPosts.sort(orderByDate);
---

<Layout>
  <div class="header">
    <h1>Blog</h1>
    <div class="divider"></div>
    <p>Space</p>
  </div>

  <div class="posts-container">
    <div class="posts-grid">
      {
        orderedPosts.map((post) => (
          <div
            class="post-item"
            id="post-item"
            data-slug={JSON.stringify(post.id)}
          >
            <Image
              class={"post-image"}
              src={`http://localhost:3000/image/${post.data.cover}`}
              inferSize
              height={300}
              width={300}
              alt="cover image for posts"
            />
            <h3>{post?.rendered?.metadata?.frontmatter.title}</h3>
            <p class="post-tag">
              {post?.rendered?.metadata?.frontmatter.primaryTag}
            </p>
          </div>
        ))
      }
    </div>
  </div>
</Layout>

<script lang="javascript">
  const posts = document.querySelectorAll("#post-item");

  posts.forEach((post) => {
    post.addEventListener("click", () => {
      const slug = JSON.parse(post.dataset.slug);
      const currentLocation = window.location.origin;
      const postUrl = `${currentLocation}/blog/${slug}.html`;
      return (window.location.href = postUrl);
    });
  });
</script>
